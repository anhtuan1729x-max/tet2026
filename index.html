<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>V√≤ng quay may m·∫Øn</title>
  <style>
    :root{
      --bg1:#fff1f5; --bg2:#ffe8cc;
      --card:#ffffffcc;
      --text:#1f2937;
      --red:#ef4444;
      --gold:#f59e0b;
      --shadow: 0 20px 60px rgba(0,0,0,.12);
      --radius: 22px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 20%, var(--bg2), transparent 60%),
        radial-gradient(1200px 800px at 80% 10%, var(--bg1), transparent 55%),
        linear-gradient(120deg, #fff7ed, #fff1f2);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      overflow:hidden;
    }
    .wrap{ width:min(520px, 100%); position:relative; }
    .card{
      background:var(--card);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.7);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:24px;
      position:relative;
      z-index:10; /* ‚úÖ n·∫±m tr√™n ph√°o hoa */
    }
    .title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    h1{ font-size:26px; line-height:1.2; margin:0; }
    .badge{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(245,158,11,.15);
      color:#92400e;
      border:1px solid rgba(245,158,11,.25);
      white-space:nowrap;
    }
    p{margin:8px 0 0; color:#374151}
    .row{ display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
    input{
      flex:1 1 240px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.08);
      outline:none;
      font-size:14px;
      background:#fff;
    }
    input:focus{
      border-color: rgba(239,68,68,.6);
      box-shadow: 0 0 0 4px rgba(239,68,68,.12);
    }
    button{
      flex:1 1 150px;
      padding:12px 14px;
      border:none;
      border-radius:14px;
      font-size:14px;
      cursor:pointer;
      transition: transform .08s ease, filter .2s ease, box-shadow .2s ease;
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .btn-primary{
      background:linear-gradient(180deg, #fb7185, #ef4444);
      color:white;
      box-shadow: 0 14px 28px rgba(239,68,68,.22);
      font-weight:700;
    }
    .btn-primary:active{ transform: translateY(1px) scale(.99); }
    .btn-ghost{
      background:transparent;
      border:1px solid rgba(0,0,0,.08);
      color:#111827;
    }
    .btn-ghost:hover{ filter:brightness(.98); }

    /* ‚úÖ N√öT "G·ª¨I TH√îNG B√ÅO" LUNG LINH */
    .btn-share{
      background: linear-gradient(180deg, #f59e0b, #ef4444);
      color:#fff;
      font-weight:900;
      letter-spacing:.2px;
      box-shadow: 0 18px 36px rgba(245,158,11,.28), 0 10px 22px rgba(239,68,68,.22);
      border:1px solid rgba(255,255,255,.25);
      transform: translateZ(0);
    }
    .btn-share:hover{
      filter: brightness(1.02);
      box-shadow: 0 22px 44px rgba(245,158,11,.35), 0 12px 26px rgba(239,68,68,.28);
      transform: translateY(-1px);
    }
    .btn-share:active{ transform: translateY(1px) scale(.99); }

    /* shimmer */
    .btn-share::before{
      content:"";
      position:absolute;
      top:-20%;
      left:-40%;
      width:60%;
      height:140%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      transform: rotate(18deg);
      opacity:.85;
      animation: shimmer 2.2s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{ left:-60%; opacity:.0; }
      15%{ opacity:.85; }
      45%{ left:110%; opacity:.0; }
      100%{ left:110%; opacity:0; }
    }

    /* glow pulse */
    .btn-share.glow{
      animation: glowPulse 1.3s ease-in-out infinite;
    }
    @keyframes glowPulse{
      0%{ box-shadow: 0 18px 36px rgba(245,158,11,.26), 0 10px 22px rgba(239,68,68,.22); }
      50%{ box-shadow: 0 22px 50px rgba(245,158,11,.42), 0 12px 30px rgba(239,68,68,.34); }
      100%{ box-shadow: 0 18px 36px rgba(245,158,11,.26), 0 10px 22px rgba(239,68,68,.22); }
    }

    /* bounce khi ra k·∫øt qu·∫£ */
    .btn-share.bounce{
      animation: bounce2 650ms ease-out 1;
    }
    @keyframes bounce2{
      0%{ transform: translateY(0) scale(1); }
      30%{ transform: translateY(-5px) scale(1.02); }
      55%{ transform: translateY(0) scale(1); }
      75%{ transform: translateY(-3px) scale(1.01); }
      100%{ transform: translateY(0) scale(1); }
    }

    /* badge "nh·ªõ ·∫•n" */
    .btn-share .ping{
      position:absolute;
      top:-10px;
      right:-10px;
      font-size:11px;
      padding:6px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.92);
      color:#991b1b;
      font-weight:900;
      border:1px solid rgba(239,68,68,.25);
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      transform: rotate(8deg);
      pointer-events:none;
    }
    .btn-share .ping::after{
      content:"";
      position:absolute;
      inset:-6px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.6);
      opacity:.0;
      animation: ring 1.2s ease-out infinite;
    }
    @keyframes ring{
      0%{ transform: scale(.85); opacity:.0; }
      30%{ opacity:.8; }
      100%{ transform: scale(1.35); opacity:0; }
    }

    .envelope{
      margin-top:18px;
      border-radius: var(--radius);
      border:1px dashed rgba(239,68,68,.35);
      background:rgba(255,255,255,.7);
      padding:18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .envelope .left{ display:flex; align-items:center; gap:12px; }
    .seal{
      width:48px; height:48px;
      border-radius:16px;
      background: radial-gradient(circle at 30% 30%, #ffd8a8, #f59e0b);
      display:grid; place-items:center;
      box-shadow: 0 12px 24px rgba(245,158,11,.25);
      border:1px solid rgba(245,158,11,.3);
      font-size:22px;
    }
    .status{ font-size:14px; }
    .status b{color:#111827}
    .amount{
      font-size:22px;
      font-weight:800;
      color:#b91c1c;
      letter-spacing:.2px;
    }
    .muted{color:#6b7280; font-size:13px}

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:50;
      background:rgba(0,0,0,.35);
    }
    .modal.show{display:flex}
    .modal .box{
      width:min(520px, 100%);
      background:white;
      border-radius: 26px;
      box-shadow: 0 30px 90px rgba(0,0,0,.3);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.6);
    }
    .box .top{
      padding:22px 22px 12px;
      background: linear-gradient(180deg, #fff7ed, #ffffff);
    }
    .box .top h2{ margin:0; font-size:20px; }
    .box .top .sub{ margin-top:6px; color:#4b5563; font-size:14px; }

    .wheelWrap{
      padding:14px 22px 0;
      display:grid;
      place-items:center;
      gap:10px;
    }
    .wheelStage{
      position:relative;
      width:min(360px, 92vw);
      aspect-ratio:1/1;
      display:grid;
      place-items:center;
    }
    canvas#wheel{
      width:100%;
      height:100%;
      border-radius:999px;
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
      background:#fff;
      border:10px solid rgba(245,158,11,.25);
    }
    .pointer{
      position:absolute;
      top:-6px;
      width:0;height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-top:26px solid #111827;
      filter: drop-shadow(0 8px 10px rgba(0,0,0,.2));
    }
    .spinBtn{
      width:100%;
      margin:0 22px;
    }

    .hongbao{
      margin:14px 22px 0;
      border-radius: 22px;
      background: linear-gradient(180deg, #ef4444, #b91c1c);
      color:white;
      padding:18px;
      position:relative;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      display:none;
    }
    .hongbao.show{display:block}
    .hongbao:before{
      content:"";
      position:absolute;
      inset:-60px;
      background:
        radial-gradient(circle at 30% 20%, rgba(245,158,11,.35), transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(245,158,11,.25), transparent 55%);
      transform: rotate(12deg);
    }
    .hongbao .inner{ position:relative; z-index:1; }
    .hongbao .line1{ font-size:14px; opacity:.95 }
    .hongbao .money{
      margin-top:8px;
      font-size:34px;
      font-weight:900;
      letter-spacing:.4px;
      color:#fde68a;
      text-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .hongbao .note{ margin-top:6px; font-size:13px; opacity:.9; }

    .box .actions{
      display:flex;
      gap:10px;
      padding:16px 22px 22px;
    }
    .actions button{ flex:1; }
    .toast{ margin:12px 22px 0; font-size:13px; color:#6b7280; }

    /* ‚úÖ canvas confetti khi tr√∫ng */
    canvas#fx{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:60;
    }

    /* ‚úÖ canvas ph√°o hoa n·ªÅn (ch·∫°y li√™n t·ª•c, ki·ªÉu ·∫£nh) */
    canvas#fireworksBg{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      opacity:.62; /* tƒÉng gi·∫£m ƒë·ªô ‚Äúr·ª±c‚Äù ·ªü ƒë√¢y */
    }

    .u-wrap{ padding:14px 22px 0; }
    .u-card{
      border:1px solid rgba(0,0,0,.08);
      border-radius:18px;
      padding:16px;
      background:#fff;
      display:grid;
      gap:10px;
    }
    .u-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .u-note{ font-size:13px; color:#6b7280; }
    .u-preview{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.06);
      background:#f9fafb;
      display:none;
      max-height:360px;
      object-fit:contain;
    }
    .u-file{
      flex: 1 1 240px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      font-size:14px;
    }
    /* ‚úÖ overlay l√†m n·ªÅn t·ªëi nh·∫π ƒë·ªÉ ph√°o hoa n·ªïi */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background: rgba(0,0,0,.14); /* tƒÉng l√™n .18 n·∫øu mu·ªën n·ªïi h∆°n */
  pointer-events:none;
  z-index:0;
}

/* ƒë·∫£m b·∫£o canvas ph√°o hoa n·∫±m tr√™n overlay */
canvas#fireworksBg{ z-index:1; opacity:1; }

/* ƒë·∫£m b·∫£o UI n·∫±m tr√™n h·∫øt */
.wrap{ position:relative; z-index:10; }
  </style>
</head>
<body>
  <!-- ‚úÖ Ph√°o hoa ch·∫°y n·ªÅn li√™n t·ª•c -->
  <canvas id="fireworksBg"></canvas>

  <!-- Confetti khi tr√∫ng -->
  <canvas id="fx"></canvas>

  <div class="wrap">
    <div class="card">
      <div class="title">
        <h1>üé° V√≤ng quayk may m·∫Øn</h1>
        <div class="badge">T·∫øt vui ‚Ä¢ Quay ph√°t tr√∫ng</div>
      </div>
      <p>Nh·∫≠p t√™n r·ªìi b·∫•m <b>M·ªü v√≤ng quay</b>. (Ch·ªâ nh·∫≠n ƒë∆∞·ª£c 1 l·∫ßn th√¥i nha üòå)</p>

      <div class="row">
        <input id="name" placeholder="T√™n c·ªßa b√© iu (vd: B√¥ng, M√®o, ...)">
        <button class="btn-primary" id="btn">üé° M·ªü v√≤ng quay</button>
      </div>

      <div class="row">
        <button class="btn-ghost" id="reset" title="Cho nh·∫≠n l·∫°i (ch·ªâ b·∫°n d√πng)">Reset</button>
        <button class="btn-ghost" id="copy">Copy l·ªùi ch√∫c</button>
      </div>

      <div class="envelope" aria-live="polite">
        <div class="left">
          <div class="seal">üßß</div>
          <div class="status">
            <div><b>Tr·∫°ng th√°i:</b> <span id="statusText">Ch∆∞a nh·∫≠n</span></div>
            <div class="muted" id="hint">B√© iu b·∫•m n√∫t ƒë·ªÉ quay nha.</div>
          </div>
        </div>
        <div class="amount" id="amountText">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- Modal quay -->
  <div class="modal" id="modal" role="dialog" aria-modal="true">
    <div class="box">
      <div class="top">
        <h2 id="mTitle">üé° Quay may m·∫Øn!(quan l·∫ßn th·ª© 5 s·∫Ω tr√∫ng x·ªãn)</h2>
        <div class="sub" id="mSub">Quay xong m·ªõi bi·∫øt tr√∫ng bao nhi√™u üíñ</div>
      </div>

      <div class="wheelWrap">
        <div class="wheelStage">
          <div class="pointer" aria-hidden="true"></div>
          <canvas id="wheel" width="720" height="720"></canvas>
        </div>
      </div>

      <div class="row spinBtn">
        <button class="btn-primary" id="spin">üåÄ Quay</button>
      </div>

      <div class="hongbao" id="resultCard">
        <div class="inner">
          <div class="line1" id="mLine">G·ª≠i t·ªõi: ‚Ä¶</div>
          <div class="money" id="mMoney">0‚Ç´</div>
          <div class="note" id="mNote">L·ªùi ch√∫c: ‚Ä¶</div>
        </div>
      </div>

      <div class="toast" id="toast">M·∫πo: Quay xong b·∫°n c√≥ th·ªÉ ch·ª•p m√†n h√¨nh g·ª≠i l·∫°i üòÑ</div>

      <div class="actions">
        <button class="btn-primary" id="close">ƒê√≥ng</button>

        <!-- ‚úÖ ƒë·ªïi n√∫t share th√†nh "lung linh" -->
        <button class="btn-share" id="share" aria-label="G·ª≠i th√¥ng b√°o">
          ‚ú® G·ª≠i th√¥ng b√°o
          <span class="ping">NH·ªö ·∫§N</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Upload ·∫£nh ƒë·ªÉ Reset -->
  <div class="modal" id="uploadModal" role="dialog" aria-modal="true">
    <div class="box">
      <div class="top">
        <h2>üì∏ Upload 1 ·∫£nh ƒë·ªÉ ƒë∆∞·ª£c quay l·∫°i</h2>
        <div class="sub">G·ª≠i ·∫£nh l√™n ƒë·ªÉ anh xem, xong h·ªá th·ªëng s·∫Ω reset cho quay ti·∫øp üòå</div>
      </div>

      <div class="u-wrap">
        <div class="u-card">
          <div class="u-row">
            <input class="u-file" id="payImg" type="file" accept="image/*">
            <button class="btn-primary" id="sendImg" disabled>G·ª≠i ·∫£nh & Reset</button>
          </div>
          <div class="u-note" id="uploadHint">Ch·ªçn ·∫£nh tr∆∞·ªõc r·ªìi m·ªõi g·ª≠i ƒë∆∞·ª£c.</div>
          <img id="preview" class="u-preview" alt="Preview ·∫£nh" />
        </div>

        <div class="toast" style="margin-left:0;margin-right:0;">
          L∆∞u √Ω: H√¨nh ·∫£nh t·∫£i l√™n ph·∫£i l√† c·ªßa ng∆∞·ªùi quay n·∫øu qu√©t ·∫£nh kh√¥ng ƒë√∫ng kh√¥ng reset l∆∞·ª£t quay.
        </div>
      </div>

      <div class="actions">
        <button class="btn-ghost" id="uploadClose">Hu·ª∑</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const ONLY_ONCE = true;
    const STORAGE_KEY = "lixi_v2_wheel_100";
    const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1470475941506449519/XwD8hUAxFhnBtd6pVEQTjXLQ_nN9FwLky2o5hmD4LIGZN5Jc-S_1wiMwjU9uAFRIQNJd";

    const PRIZES = [
      { money: 20000,  label: "20k"  },
      { money: 50000,  label: "50k"  },
      { money: 70000,  label: "70k"  },
      { money: 100000, label: "100k" },
      { money: 150000, label: "150k" },
      { money: 200000, label: "200k" },
      { money: 300000, label: "300k" },
      { money: 500000, label: "500k" }
    ];

    const WISHES = [
      "NƒÉm m·ªõi lu√¥n xinh ƒë·∫πp, vui v·∫ª v√† y√™u anh nhi·ªÅu h∆°n üòö",
      "Ch√∫c m√¨nh lu√¥n b√™n nhau, h·∫°nh ph√∫c d√†i l√¢u üíñ",
      "Ch√∫c b√© iu h·ªçc gi·ªèi, g·∫∑p nhi·ªÅu may m·∫Øn ‚ú®",
      "Ch√∫c b√© iu c∆∞·ªùi nhi·ªÅu h∆°n, bu·ªìn √≠t l·∫°i, th∆∞∆°ng anh nhi·ªÅu h∆°n üòå"
    ];

    // ===== DOM =====
    const $ = (id) => document.getElementById(id);
    const nameEl = $("name");
    const btn = $("btn");
    const resetBtn = $("reset");
    const copyBtn = $("copy");
    const statusText = $("statusText");
    const amountText = $("amountText");

    const modal = $("modal");
    const closeBtn = $("close");
    const shareBtn = $("share");
    const spinBtn = $("spin");

    const resultCard = $("resultCard");
    const mLine = $("mLine");
    const mMoney = $("mMoney");
    const mNote = $("mNote");
    const mSub = $("mSub");
    const toast = $("toast");

    // Upload modal
    const uploadModal = $("uploadModal");
    const uploadClose = $("uploadClose");
    const payImg = $("payImg");
    const sendImg = $("sendImg");
    const preview = $("preview");
    const uploadHint = $("uploadHint");

    // Wheel canvas
    const wheelCanvas = $("wheel");
    const wctx = wheelCanvas.getContext("2d");

    // ===== Utils =====
    const fmtVND = (n) => n.toLocaleString("vi-VN") + "‚Ç´";
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const randPick = (arr) => arr[randInt(0, arr.length - 1)];
    const norm = (s) => (s || "").trim().toLowerCase();

    function randomWish() { return randPick(WISHES); }

    function loadState() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); }
      catch { return null; }
    }
    function saveState(s) { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
    function clearState() { localStorage.removeItem(STORAGE_KEY); }

    function setReceivedUI(state) {
      statusText.textContent = "ƒê√£ nh·∫≠n";
      amountText.textContent = fmtVND(state.money);
      $("hint").textContent = `Nh·∫≠n b·ªüi "${state.name}" l√∫c ${new Date(state.time).toLocaleString("vi-VN")}`;
      btn.disabled = true;
      btn.textContent = "‚úÖ ƒê√£ nh·∫≠n r·ªìi";
      btn.style.filter = "grayscale(.15)";
      btn.style.cursor = "not-allowed";
    }

    function setNotReceivedUI() {
      statusText.textContent = "Ch∆∞a nh·∫≠n";
      amountText.textContent = "‚Äî";
      $("hint").textContent = "B√© iu b·∫•m n√∫t ƒë·ªÉ quay nha.";
      btn.disabled = false;
      btn.textContent = "üé° M·ªü v√≤ng quay";
      btn.style.filter = "";
      btn.style.cursor = "pointer";
    }

    // ‚úÖ b·∫≠t/t·∫Øt hi·ªáu ·ª©ng cho n√∫t share
    function highlightShare(on) {
      if (!shareBtn) return;
      shareBtn.classList.toggle("glow", !!on);
    }
    function bounceShare() {
      if (!shareBtn) return;
      shareBtn.classList.remove("bounce");
      void shareBtn.offsetWidth;
      shareBtn.classList.add("bounce");
      setTimeout(()=> shareBtn.classList.remove("bounce"), 800);
    }

    // ============================================================
    // ‚úÖ BACKGROUND PH√ÅO HOA (ƒê·∫∏P KI·ªÇU ·∫¢NH: ch√πm n·ªü + ƒëu√¥i + fan)
    // ============================================================
    const fw = $("fireworksBg");
    const fwctx = fw.getContext("2d");

    let W = 0, H = 0;
    let running = true;

    function fwResize(){
      W = window.innerWidth;
      H = window.innerHeight;
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      fw.width  = Math.floor(W * dpr);
      fw.height = Math.floor(H * dpr);
      fw.style.width = W + "px";
      fw.style.height = H + "px";
      fwctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener("resize", fwResize);
    fwResize();

    const rand = (a,b)=>Math.random()*(b-a)+a;
    const rndi = (a,b)=>Math.floor(rand(a,b+1));
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    function hsla(h,s,l,a){ return `hsla(${h},${s}%,${l}%,${a})`; }

    const rockets = [];
    const sparks  = [];
    const glitter = [];
    const fountains = [];

    function addFountain() {
      fountains.push({
        x: rand(W*0.10, W*0.90),
        y: H - 10,
        spread: rand(0.9, 1.5),
        hue: rand(0, 360),
        t: 0,
        life: rndi(260, 420)
      });
    }

    function spawnRocket() {
      const x = rand(W*0.15, W*0.85);
      rockets.push({
        x,
        y: H + 12,
        vx: rand(-1.2, 1.2),
        vy: rand(-13.0, -17.2),
        hue: rand(0, 360),
        life: 0,
        ty: rand(H*0.14, H*0.44),
        trail: []
      });
    }

    function explodeChrysanthemum(x, y, hue) {
      const layers = rndi(2, 4);
      for (let L=0; L<layers; L++){
        const count = rndi(85, 150);
        const baseSpd = rand(2.8, 6.4) + L*rand(0.7, 1.3);
        const lShift = rand(-10, 10);

        for (let i=0;i<count;i++){
          const ang = (i / count) * Math.PI*2 + rand(-0.02,0.02);
          const spd = baseSpd * rand(0.75, 1.12);
          sparks.push({
            x, y,
            vx: Math.cos(ang)*spd,
            vy: Math.sin(ang)*spd,
            g: rand(0.055, 0.10),
            a: 1,
            r: rand(1.2, 2.6),
            hue: (hue + rand(-18, 18) + 360) % 360,
            sat: rand(88, 100),
            lit: clamp(58 + lShift, 48, 72),
            drag: rand(0.983, 0.991),
            decay: rand(0.0055, 0.0105),
            twinkle: Math.random() < 0.60
          });
        }
      }

      const gCount = rndi(55, 95);
      for (let i=0;i<gCount;i++){
        glitter.push({
          x, y,
          vx: rand(-2.6, 2.6),
          vy: rand(-1.2, 2.0),
          g: rand(0.08, 0.14),
          a: 1,
          hue: (hue + rand(-30,30)+360)%360,
          decay: rand(0.010, 0.017),
          r: rand(0.9, 1.7)
        });
      }
    }

    function explodeDouble(x, y, hue) {
      explodeChrysanthemum(x + rand(-24,24), y + rand(-14,14), hue);
      explodeChrysanthemum(x + rand(-24,24), y + rand(-14,14), (hue+rand(30,120))%360);
    }

    function drawTrail(trail, hue){
      if (trail.length < 2) return;
      fwctx.beginPath();
      fwctx.moveTo(trail[0].x, trail[0].y);
      for (let i=1;i<trail.length;i++) fwctx.lineTo(trail[i].x, trail[i].y);
      fwctx.strokeStyle = hsla(hue, 95, 60, 0.40);
      fwctx.lineWidth = 2.4;
      fwctx.stroke();

      const last = trail[trail.length-1];
      fwctx.beginPath();
      fwctx.arc(last.x, last.y, 2.6, 0, Math.PI*2);
      fwctx.fillStyle = hsla(hue, 95, 60, 0.90);
      fwctx.fill();
    }

    let lastSpawn = 0;
    let lastFountain = 0;

    function fwTick(ts){
      if (!running) return;

      fwctx.globalCompositeOperation = "source-over";
      fwctx.fillStyle = "rgba(0,0,0,0.10)"; // fade b·∫±ng ƒëen ƒë·ªÉ gi·ªØ v·ªát s√°ng
      fwctx.fillRect(0,0,W,H);

      fwctx.globalCompositeOperation = "lighter";

      // d√†y h∆°n ƒë·ªÉ gi·ªëng vibe ·∫£nh
      if (ts - lastSpawn > rand(220, 420)){
        spawnRocket();
        if (Math.random() < 0.30) spawnRocket();
        lastSpawn = ts;
      }

      if (ts - lastFountain > rand(850, 1400)){
        addFountain();
        if (Math.random() < 0.35) addFountain();
        lastFountain = ts;
      }

      // fountains
      for (let i=fountains.length-1;i>=0;i--){
        const f = fountains[i];
        f.t++;
        f.life--;

        const bursts = 3;
        for (let b=0;b<bursts;b++){
          const ang = rand(-Math.PI*0.82, -Math.PI*0.18);
          const spd = rand(3.8, 8.4) * f.spread;
          sparks.push({
            x: f.x + rand(-10,10),
            y: f.y,
            vx: Math.cos(ang)*spd,
            vy: Math.sin(ang)*spd,
            g: rand(0.10, 0.16),
            a: 0.92,
            r: rand(0.9, 1.9),
            hue: (f.hue + rand(-12,12)+360)%360,
            sat: rand(82, 98),
            lit: rand(56, 70),
            drag: rand(0.975, 0.988),
            decay: rand(0.010, 0.018),
            twinkle: true
          });
        }

        if (f.life <= 0) fountains.splice(i,1);
      }

      // rockets
      for (let i=rockets.length-1;i>=0;i--){
        const r = rockets[i];
        r.life++;

        r.x += r.vx;
        r.y += r.vy;
        r.vy += 0.082;

        r.trail.push({x:r.x, y:r.y});
        if (r.trail.length > 20) r.trail.shift();

        drawTrail(r.trail, r.hue);

        if (r.y <= r.ty || r.life > 170){
          if (Math.random() < 0.36) explodeDouble(r.x, r.y, r.hue);
          else explodeChrysanthemum(r.x, r.y, r.hue);
          rockets.splice(i,1);
        }
      }

      // sparks
      for (let i=sparks.length-1;i>=0;i--){
        const p = sparks[i];
        p.vy += p.g;
        p.x += p.vx;
        p.y += p.vy;
        p.vx *= p.drag;
        p.vy *= p.drag;
        p.a -= p.decay;

        if (p.twinkle && Math.random() < 0.10) p.a *= 0.65;

        if (p.a <= 0 || p.y > H + 90){
          sparks.splice(i,1);
          continue;
        }

        fwctx.globalAlpha = clamp(p.a, 0, 1);

        fwctx.beginPath();
        fwctx.arc(p.x, p.y, p.r*1.9, 0, Math.PI*2);
        fwctx.fillStyle = hsla(p.hue, p.sat, p.lit, 0.22);
        fwctx.fill();

        fwctx.beginPath();
        fwctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        fwctx.fillStyle = hsla(p.hue, p.sat, p.lit, 0.98);
        fwctx.fill();

        fwctx.globalAlpha = 1;
      }

      // glitter
      for (let i=glitter.length-1;i>=0;i--){
        const g = glitter[i];
        g.vy += g.g;
        g.x += g.vx;
        g.y += g.vy;
        g.a -= g.decay;

        if (g.a <= 0 || g.y > H + 70){
          glitter.splice(i,1);
          continue;
        }

        fwctx.globalAlpha = clamp(g.a, 0, 1);
        fwctx.beginPath();
        fwctx.arc(g.x, g.y, g.r, 0, Math.PI*2);
        fwctx.fillStyle = hsla(g.hue, 95, 66, 0.95);
        fwctx.fill();
        fwctx.globalAlpha = 1;
      }

      requestAnimationFrame(fwTick);
    }
    requestAnimationFrame(fwTick);

    document.addEventListener("visibilitychange", () => {
      running = !document.hidden;
      if (running) requestAnimationFrame(fwTick);
    });

    // ===== Confetti (khi tr√∫ng) =====
    const fx = $("fx");
    const ctx = fx.getContext("2d");
    let particles = [];
    function resize() {
      fx.width = window.innerWidth * devicePixelRatio;
      fx.height = window.innerHeight * devicePixelRatio;
      fx.style.width = window.innerWidth + "px";
      fx.style.height = window.innerHeight + "px";
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    }
    window.addEventListener("resize", resize);
    resize();

    function popConfetti() {
      const colors = ["#ef4444","#f59e0b","#22c55e","#3b82f6","#a855f7","#f472b6"];
      const count = 180;
      particles = [];
      for (let i=0;i<count;i++){
        particles.push({
          x: window.innerWidth/2,
          y: window.innerHeight/3,
          vx: (Math.random()-0.5)*14,
          vy: (Math.random()-1.2)*14,
          g: 0.28 + Math.random()*0.12,
          r: 3 + Math.random()*4,
          c: colors[Math.floor(Math.random()*colors.length)],
          a: 1
        });
      }
      function tick(){
        ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
        particles.forEach(p=>{
          p.vy += p.g;
          p.x += p.vx;
          p.y += p.vy;
          p.a *= 0.992;
          ctx.globalAlpha = p.a;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
          ctx.fillStyle = p.c;
          ctx.fill();
        });
        ctx.globalAlpha = 1;
        particles = particles.filter(p=>p.a>0.06 && p.y < window.innerHeight+50);
        if (particles.length) requestAnimationFrame(tick);
        else ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      }
      requestAnimationFrame(tick);
    }

    // ===== Modal quay =====
    function openModalBase(name) {
      mSub.textContent = `Quay xong ch√∫c ${name} nƒÉm m·ªõi b√¨nh an & r·ª±c r·ª° ‚ú®`;
      resultCard.classList.remove("show");
      toast.textContent = "M·∫πo: Quay xong b·∫°n c√≥ th·ªÉ ch·ª•p m√†n h√¨nh g·ª≠i l·∫°i üòÑ";
      modal.classList.add("show");
    }
    function closeModal(){ modal.classList.remove("show"); }

    closeBtn.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

    // ===== Upload modal =====
    function openUploadModal() {
      payImg.value = "";
      preview.src = "";
      preview.style.display = "none";
      sendImg.disabled = true;
      uploadHint.textContent = "Ch·ªçn ·∫£nh tr∆∞·ªõc r·ªìi m·ªõi g·ª≠i ƒë∆∞·ª£c.";
      uploadModal.classList.add("show");
    }
    function closeUploadModal() { uploadModal.classList.remove("show"); }

    uploadClose.addEventListener("click", closeUploadModal);
    uploadModal.addEventListener("click", (e) => { if (e.target === uploadModal) closeUploadModal(); });

    payImg.addEventListener("change", () => {
      const file = payImg.files?.[0];
      if (!file) {
        preview.style.display = "none";
        sendImg.disabled = true;
        uploadHint.textContent = "Ch·ªçn ·∫£nh tr∆∞·ªõc r·ªìi m·ªõi g·ª≠i ƒë∆∞·ª£c.";
        return;
      }
      if (!file.type.startsWith("image/")) {
        alert("Ch·ªâ ch·ªçn file ·∫£nh th√¥i nha.");
        payImg.value = "";
        preview.style.display = "none";
        sendImg.disabled = true;
        uploadHint.textContent = "Ch·ªçn ·∫£nh tr∆∞·ªõc r·ªìi m·ªõi g·ª≠i ƒë∆∞·ª£c.";
        return;
      }
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.style.display = "block";
      sendImg.disabled = false;
      uploadHint.textContent = "Ok r·ªìi, b·∫•m ‚ÄúG·ª≠i ·∫£nh & Reset‚Äù.";
    });

    async function sendImageToDiscord(file) {
      if (!DISCORD_WEBHOOK_URL) throw new Error("Missing webhook URL");

      const who = (nameEl.value || "").trim() || "B√© iu";
      const time = new Date().toLocaleString("vi-VN");

      const fd = new FormData();
      fd.append("file", file, file.name);

      fd.append("payload_json", JSON.stringify({
        content:
`üì∏ ·∫¢NH ƒê·ªÇ RESET V√íNG QUAY
üë§ Ng∆∞·ªùi g·ª≠i: ${who}
üïí Th·ªùi gian: ${time}
üßæ Ghi ch√∫: Upload 1 ·∫£nh = 1 l∆∞·ª£t reset`
      }));

      const res = await fetch(DISCORD_WEBHOOK_URL, { method: "POST", body: fd });
      if (!res.ok) throw new Error("Webhook failed: " + res.status);
    }

    // ===== Wheel draw =====
    const CX = wheelCanvas.width / 2;
    const CY = wheelCanvas.height / 2;
    const R  = Math.min(CX, CY) - 18;

    let angle = 0;
    function drawWheel(currentAngle = 0) {
      wctx.clearRect(0,0,wheelCanvas.width,wheelCanvas.height);
      const n = PRIZES.length;
      const step = (Math.PI * 2) / n;

      wctx.beginPath();
      wctx.arc(CX, CY, R + 8, 0, Math.PI*2);
      wctx.fillStyle = "rgba(245,158,11,.15)";
      wctx.fill();

      for (let i = 0; i < n; i++) {
        const start = currentAngle + i * step;
        const end   = start + step;

        wctx.beginPath();
        wctx.moveTo(CX, CY);
        wctx.arc(CX, CY, R, start, end);
        wctx.closePath();
        wctx.fillStyle = (i % 2 === 0) ? "#ef4444" : "#f59e0b";
        wctx.fill();

        wctx.save();
        wctx.translate(CX, CY);
        wctx.rotate(start + step/2);
        wctx.textAlign = "right";
        wctx.fillStyle = "white";
        wctx.font = "bold 34px ui-sans-serif, system-ui";
        wctx.fillText(PRIZES[i].label, R - 18, 12);
        wctx.restore();
      }

      wctx.beginPath();
      wctx.arc(CX, CY, 70, 0, Math.PI*2);
      wctx.fillStyle = "#111827";
      wctx.fill();

      wctx.fillStyle = "#fde68a";
      wctx.font = "800 28px ui-sans-serif, system-ui";
      wctx.textAlign = "center";
      wctx.fillText("QUAY", CX, CY + 10);
    }
    drawWheel(angle);

    // ===== Spin logic =====
    let spinning = false;
    let forcedIndex = null;

    function angleToIndex(a) {
      const n = PRIZES.length;
      const step = (Math.PI * 2) / n;
      const pointer = -Math.PI / 2;
      let x = (pointer - a) % (Math.PI*2);
      if (x < 0) x += Math.PI*2;
      return Math.floor(x / step) % n;
    }

    function angleForIndexInside(idx, baseAngle = 0) {
      const n = PRIZES.length;
      const step = (Math.PI * 2) / n;
      const pointer = -Math.PI / 2;
      const margin = 0.15 * step;
      const inside = margin + Math.random() * (step - 2 * margin);
      let target = pointer - (idx * step + inside);

      target = ((target % (Math.PI*2)) + (Math.PI*2)) % (Math.PI*2);
      const base = ((baseAngle % (Math.PI*2)) + (Math.PI*2)) % (Math.PI*2);

      let delta = target - base;
      if (delta < 0) delta += Math.PI * 2;
      return { delta };
    }

    function spinToIndex(targetIndex) {
      spinning = true;
      spinBtn.disabled = true;
      spinBtn.textContent = "üåÄ ƒêang quay...";
      resultCard.classList.remove("show");
      highlightShare(false);

      const extraSpins = 6 + Math.floor(Math.random()*3);
      const duration = 3600 + Math.random()*600;
      const start = performance.now();
      const startAngle = angle;

      const { delta } = angleForIndexInside(targetIndex, startAngle);
      const finalAngle = startAngle + delta + extraSpins * Math.PI * 2;

      const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

      function tick(now) {
        const t = Math.min(1, (now - start) / duration);
        const eased = easeOutCubic(t);
        angle = startAngle + (finalAngle - startAngle) * eased;
        drawWheel(angle);

        if (t < 1) requestAnimationFrame(tick);
        else {
          angle = angle % (Math.PI*2);
          const landed = angleToIndex(angle);

          spinning = false;
          spinBtn.disabled = true;
          spinBtn.textContent = "‚úÖ ƒê√£ quay";

          onLanded(forcedIndex ?? landed);
          forcedIndex = null;
        }
      }
      requestAnimationFrame(tick);
    }

    function showResult({name, money, wish}) {
      mLine.textContent = `G·ª≠i t·ªõi: ${name}`;
      mMoney.textContent = fmtVND(money);
      mNote.textContent = `L·ªùi ch√∫c: ${wish}`;
      resultCard.classList.add("show");
      popConfetti();

      highlightShare(true);
      bounceShare();
      setTimeout(bounceShare, 900);
    }

    function onLanded(index) {
      const name = (nameEl.value || "").trim() || "B√© iu";
      const prize = PRIZES[index];
      const wish = randomWish();

      const newState = { name, money: prize.money, wish, time: Date.now(), prizeIndex: index };
      saveState(newState);
      setReceivedUI(newState);

      showResult(newState);
      toast.textContent = "Tr√∫ng r·ªìi ƒë√≥oo ‚úÖ Nh·ªõ ·∫•n n√∫t ‚ú®G·ª≠i th√¥ng b√°o‚ú® ƒë·ªÉ b√°o anh nha";
    }

    function prepareSpinUI() {
      spinBtn.disabled = false;
      spinBtn.textContent = "üåÄ Quay";
      angle = Math.random() * Math.PI * 2;
      drawWheel(angle);
      highlightShare(false);
    }

    function pickIndex20k() {
      const idxs = [];
      PRIZES.forEach((p,i)=>{ if (p.money === 20000) idxs.push(i); });
      return idxs.length ? idxs[Math.floor(Math.random()*idxs.length)] : 0;
    }

    // ===== Init =====
    const existing = loadState();
    if (existing && ONLY_ONCE) setReceivedUI(existing);

    btn.addEventListener("click", () => {
      const name = (nameEl.value || "").trim() || "B√© iu";
      const state = loadState();

      openModalBase(name);

      if (ONLY_ONCE && state) {
        const n = PRIZES.length;
        const step = (Math.PI * 2) / n;
        const pointer = -Math.PI / 2;
        const inside = (0.35 * step);
        angle = pointer - (state.prizeIndex * step + inside);
        drawWheel(angle);

        spinBtn.disabled = true;
        spinBtn.textContent = "‚úÖ ƒê√£ quay";
        showResult({name: state.name, money: state.money, wish: state.wish});
        toast.textContent = "B·∫°n ƒë√£ nh·∫≠n r·ªìi üòå (k·∫øt qu·∫£ c≈© n√®)";
        return;
      }

      prepareSpinUI();
    });

    spinBtn.addEventListener("click", () => {
      if (spinning) return;
      const idx = pickIndex20k();
      forcedIndex = idx;
      spinToIndex(idx);
    });

    shareBtn.addEventListener("click", async () => {
      const s = loadState();
      if (!s) return;

      const message =
`üé° V√íNG QUAY L√å X√å ƒê√É C√ì K·∫æT QU·∫¢!
üë§ Ng∆∞·ªùi nh·∫≠n: ${s.name}
üí∞ S·ªë ti·ªÅn: ${fmtVND(s.money)} (${PRIZES[s.prizeIndex]?.label ?? ""})
üïí Th·ªùi gian: ${new Date(s.time).toLocaleString("vi-VN")}
üíå L·ªùi ch√∫c: ${s.wish}`;

      try {
        const res = await fetch(DISCORD_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: message })
        });

        if (!res.ok) throw new Error("Webhook failed: " + res.status);

        toast.textContent = "ƒê√£ g·ª≠i th√¥ng b√°o t·ªõi anh iu ‚úÖ";
        highlightShare(false);
        setTimeout(()=> toast.textContent = "M·∫πo: Quay xong b·∫°n c√≥ th·ªÉ ch·ª•p m√†n h√¨nh g·ª≠i l·∫°i üòÑ", 1600);
      } catch (e) {
        try {
          await navigator.clipboard.writeText(message);
          alert("Kh√¥ng g·ª≠i t·ª± ƒë·ªông ƒë∆∞·ª£c üò≠ M√¨nh ƒë√£ copy n·ªôi dung, b·∫°n d√°n g·ª≠i cho anh nh√©!");
        } catch {
          alert("Kh√¥ng g·ª≠i ƒë∆∞·ª£c v√† c≈©ng kh√¥ng copy ƒë∆∞·ª£c. M·ªü console xem l·ªói nh√©.");
        }
      }
    });

    copyBtn.addEventListener("click", async () => {
      const s = loadState();
      const name = (nameEl.value || "").trim() || (s?.name ?? "b√© iu");
      const text = `Ch√∫c ${name} nƒÉm m·ªõi vui v·∫ª, g·∫∑p nhi·ªÅu may m·∫Øn v√† lu√¥n h·∫°nh ph√∫c üíñ`;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = "‚úÖ ƒê√£ copy";
        setTimeout(()=> copyBtn.textContent = "Copy l·ªùi ch√∫c", 1200);
      } catch {
        alert("Kh√¥ng copy ƒë∆∞·ª£c. ƒê√¢y l√† l·ªùi ch√∫c:\n" + text);
      }
    });

    function doReset() {
      clearState();
      setNotReceivedUI();
      resultCard.classList.remove("show");
      spinBtn.disabled = false;
      spinBtn.textContent = "üåÄ Quay";
      forcedIndex = null;
      spinning = false;
      highlightShare(false);
    }

    resetBtn.addEventListener("click", () => {
      const who = norm(nameEl.value);
      if (who === "tu·∫•n") {
        doReset();
        return;
      }
      openUploadModal();
    });

    // Upload modal
    function openUploadModal() {
      payImg.value = "";
      preview.src = "";
      preview.style.display = "none";
      sendImg.disabled = true;
      uploadHint.textContent = "Ch·ªçn ·∫£nh tr∆∞·ªõc r·ªìi m·ªõi g·ª≠i ƒë∆∞·ª£c.";
      uploadModal.classList.add("show");
    }
    function closeUploadModal() { uploadModal.classList.remove("show"); }

    uploadClose.addEventListener("click", closeUploadModal);
    uploadModal.addEventListener("click", (e) => { if (e.target === uploadModal) closeUploadModal(); });

    sendImg.addEventListener("click", async () => {
      const file = payImg.files?.[0];
      if (!file) return;

      sendImg.disabled = true;
      sendImg.textContent = "ƒêang g·ª≠i...";
      uploadHint.textContent = "ƒêang g·ª≠i ·∫£nh l√™n h√≠ h√≠...";

      try {
        await sendImageToDiscord(file);
        uploadHint.textContent = "G·ª≠i ·∫£nh xong ‚úÖ ƒêang reset...";
        doReset();
        closeUploadModal();
      } catch (e) {
        console.error(e);
        uploadHint.textContent = "G·ª≠i th·∫•t b·∫°i üò≠ (c√≥ th·ªÉ do CORS).";
        alert("Kh√¥ng g·ª≠i ·∫£nh tr·ª±c ti·∫øp ƒë∆∞·ª£c. N·∫øu b·ªã CORS th√¨ c·∫ßn backend/proxy ƒë·ªÉ upload l√™n Discord.");
      } finally {
        sendImg.textContent = "G·ª≠i ·∫£nh & Reset";
        sendImg.disabled = !payImg.files?.[0];
      }
    });
  </script>
</body>
</html>
